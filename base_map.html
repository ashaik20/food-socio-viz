<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <!-- add title -->
    <title>Food Nutrition Indices: Data Visualization</title>
    
    <!-- import required libraries here -->
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="../lib/topojson.v2.min.js"></script>
    <script type="text/javascript" src="../lib/d3-tip.min.js"></script>
    <script type="text/javascript" src="../lib/d3-legend.min.js"></script>
    <script type="text/javascript" src="../lib/d3-geo-projection.v2.min.js"></script>
</head>


<body>
    <!-- Add heading for the visualization -->
    <h2>Food Nutrition Indices: Data Visualization</h2>
    

    <script>
    
        // enter code to define margin and dimensions for svg
        const margin = {top: 50, right: 20, bottom: 50, left: 20};
        const width = 1200 - margin.left - margin.right;
        const height = 600 - margin.top - margin.bottom;
        
        // enter code to create svg
        const svg1 = d3.select('body').append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .attr('id', 'choropleth')
            

        const svg = svg1.append('g')
            .attr('id', 'countries')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        var projection = d3.geoNaturalEarth()
            .scale(200)
            .translate([width / 2 - 100, height / 1.5 - 100]);
        var path = d3.geoPath().projection(projection);

        Promise.all([ 
            // enter code to read files
            d3.json('./data/world_countries.json'),
            d3.csv('./data/country_nutrition_scores.csv')

        ]).then(
            // enter code to call ready() with required arguments
            ([world, nutritionScores]) => {
                ready(world, nutritionScores);
            }
        );
        
        // this function should be called once the data from files have been read
        // world: topojson from world_countries.json
        function ready(world, nutritionScores) {
            // create Choropleth with default option. Call createMapAndLegend() with required arguments.

            const nutrMap = {};
            nutritionScores.forEach(d => {
                nutrMap[d.ISO3] = +d['Nutrition Score'];
            });

            createMapAndLegend(world, nutrMap);
        }

        // this function should create a Choropleth map
        function createMapAndLegend(world, nutrMap){ 
            svg.selectAll("path").remove();

            const color = d3.scaleSequential()
                .domain(d3.extent(Object.values(nutrMap)))
                .interpolator(d3.interpolateYlGnBu);

            // Create a single tooltip div (don't append multiple times on re-render)
            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("position", "absolute")
                    .style("padding", "6px 10px")
                    .style("background", "white")
                    .style("border", "1px solid #ccc")
                    .style("border-radius", "4px")
                    .style("pointer-events", "none")
                    .style("opacity", 0)
                    .style("z-index", 9999)
                    .style("max-width", "300px");
            }

            svg.selectAll("path")
                .data(world.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", d => {
                    const score = nutrMap[d.id];
                    return score !== undefined ? color(score) : "#ccc";
                })
                .attr("stroke", "#333")
                .attr("stroke-width", 0.5)
                .on("mouseover", function(d) {
                    const score = nutrMap[d.id];
                    const px = d3.event && d3.event.pageX ? d3.event.pageX : 0;
                    const py = d3.event && d3.event.pageY ? d3.event.pageY : 0;
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip.html(`<strong>${d.properties.name}</strong><br/>Nutrition Score: ${score !== undefined ? score : 'N/A'}`)
                        .style("left", (px + 10) + "px")
                        .style("top", (py - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition().duration(500).style("opacity", 0);
                });

            const legend = d3.legendColor()
                .shapeWidth(30)
                .cells(10)
                .orient('horizontal')
                .scale(color)
                .title("Nutrition Score");
        
            svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(0, ${height + margin.bottom - 10})`)
                .call(legend);
        }
    </script>
</body>

</html>
